---
# User management tasks

- name: Create ssh-users group
  ansible.builtin.group:
    name: ssh-users
    state: present

- name: Create deploy user
  ansible.builtin.user:
    name: "{{ baseline__deploy_user }}"
    groups:
      - sudo
      - ssh-users
    shell: /bin/bash
    create_home: true
    state: present

- name: Set authorized keys for deploy user
  ansible.posix.authorized_key:
    user: "{{ baseline__deploy_user }}"
    key: "{{ item }}"
    state: present
    exclusive: false
  loop: "{{ baseline__ssh_public_keys }}"
  when: baseline__ssh_public_keys | length > 0
  no_log: true

- name: Configure passwordless sudo for deploy user
  ansible.builtin.copy:
    content: "{{ baseline__deploy_user }} ALL=(ALL) NOPASSWD:ALL"
    dest: "/etc/sudoers.d/{{ baseline__deploy_user }}"
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Set correct permissions on .ssh directory
  ansible.builtin.file:
    path: "/home/{{ baseline__deploy_user }}/.ssh"
    state: directory
    owner: "{{ baseline__deploy_user }}"
    group: "{{ baseline__deploy_user }}"
    mode: '0700'

- name: Set correct permissions on authorized_keys
  ansible.builtin.file:
    path: "/home/{{ baseline__deploy_user }}/.ssh/authorized_keys"
    owner: "{{ baseline__deploy_user }}"
    group: "{{ baseline__deploy_user }}"
    mode: '0600'
  failed_when: false
