---
# Firewall (UFW) configuration tasks

- name: Install UFW
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: true

- name: Reset UFW to defaults
  community.general.ufw:
    state: reset
  when: baseline__firewall_reset | default(false)

- name: Set default deny incoming
  community.general.ufw:
    direction: incoming
    policy: deny

- name: Set default allow outgoing
  community.general.ufw:
    direction: outgoing
    policy: allow

- name: Allow SSH (critical - before enabling firewall)
  community.general.ufw:
    rule: allow
    port: "{{ baseline__ssh_port }}"
    proto: tcp
    comment: "SSH access"

- name: Rate limit SSH
  community.general.ufw:
    rule: limit
    port: "{{ baseline__ssh_port }}"
    proto: tcp
    comment: "Rate limit SSH"
  when: baseline__firewall_rate_limit_ssh | default(true)

- name: Allow configured ports
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.proto | default('tcp') }}"
    from_ip: "{{ item.from | default('any') }}"
    comment: "{{ item.comment | default(omit) }}"
  loop: "{{ baseline__firewall_allowed_ports }}"

- name: Enable UFW
  community.general.ufw:
    state: enabled
    logging: "{{ baseline__firewall_logging | default('on') }}"

- name: Enable UFW service
  ansible.builtin.systemd:
    name: ufw
    enabled: true
    state: started
